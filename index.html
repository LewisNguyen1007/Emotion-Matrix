<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Kích hoạt Cảm xúc (Emotion Activation Simulator)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: #f8fafc; /* gray-50 */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 9999px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Mô phỏng Kích hoạt Cảm xúc</h1>
            <p class="mt-2 text-md text-gray-600">Dựa trên Mô hình Thẩm định Đa chiều Tính toán</p>
            <div class="mt-4 inline-flex items-center space-x-2 text-sm bg-gray-100 p-2 rounded-lg">
                <span class="font-mono bg-white px-2 py-1 rounded">aₑ = Wₑ ⋅ V + bₑ</span>
                <span>→</span>
                <span class="font-mono bg-white px-2 py-1 rounded">ãₑ = tanh(aₑ)</span>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            
            <!-- Input Card -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-4">Vector Tình huống (V)</h2>
                <div id="sliders-container" class="space-y-4">
                    <!-- Sliders will be dynamically inserted here -->
                </div>

                <div class="mt-6 border-t pt-4">
                     <div class="flex items-center justify-between">
                        <label class="text-lg font-medium text-gray-700">Thiên kiến Tính khí (bₑ)</label>
                        <button id="toggle-bias" class="px-4 py-2 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Hiển thị</button>
                    </div>
                    <div id="bias-panel" class="hidden mt-4 space-y-4">
                        <!-- Bias sliders will be inserted here -->
                    </div>
                </div>
                 <div class="mt-6 border-t pt-4 flex items-center space-x-4">
                    <button id="reset-v" class="w-full px-4 py-2 font-semibold bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">Reset V = 0</button>
                    <button id="export-json" class="w-full px-4 py-2 font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Export JSON</button>
                </div>
            </div>

            <!-- Output Card -->
            <div class="card p-6">
                 <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-4">Kết quả Kích hoạt (ãₑ)</h2>
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-gray-600">Cảm xúc</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-right">Kích hoạt Thô (aₑ)</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-right">Kích hoạt Cảm nhận (ãₑ)</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                       <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                 <p class="mt-4 text-sm text-gray-500">Ghi chú: Bảng được sắp xếp theo mức độ kích hoạt cảm nhận giảm dần. Hãy thử thay đổi các thanh trượt để thấy kết quả cập nhật theo thời gian thực.</p>
            </div>
        </div>
    </div>

    <script>
        // --- MODEL CONFIGURATION ---

        const DIMENSIONS = [
            "Goal Congruence", "PFCA", "Attachment",
            "Causal_Self", "Causal_Other", "Causal_Circumstance",
            "Perceived Justice", "Social Esteem"
        ];

        // Normalized Weight Matrix W (L2 norm per emotion ≈ 1)
        const WEIGHTS = {
            "Anger":     [-0.465,  0.103,  0.413,  0.000,  0.516,  0.052, -0.516,  0.258],
            "Anxiety":   [-0.586, -0.586,  0.410,  0.000,  0.000,  0.293,  0.059,  0.234],
            "Guilt":     [-0.459,  0.153,  0.408,  0.510,  0.000,  0.000,  0.357,  0.459],
            "Pride":     [ 0.523, -0.262,  0.314,  0.523,  0.000,  0.000, -0.105,  0.523],
            "Gratitude": [ 0.595,  0.060,  0.238,  0.000,  0.595,  0.119, -0.298, -0.357]
        };

        const EMOTIONS = Object.keys(WEIGHTS);

        // --- UI ELEMENT GENERATION ---

        const slidersContainer = document.getElementById('sliders-container');
        const biasContainer = document.getElementById('bias-panel');

        // Function to create a single slider row
        function createSliderRow(name, prefix) {
            const id = `${prefix}_${name.replace(/[^a-z0-9]/gi, '_')}`;
            const isBias = prefix === 'B';
            
            const wrapper = document.createElement('div');
            
            const label = document.createElement('label');
            label.htmlFor = id;
            label.className = "block text-sm font-medium text-gray-600";
            label.textContent = name;
            
            const controlsWrapper = document.createElement('div');
            controlsWrapper.className = 'flex items-center space-x-3 mt-1';
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = id;
            slider.min = -1;
            slider.max = 1;
            slider.step = 0.01;
            slider.value = 0;
            slider.className = "w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer";
            
            const valueDisplay = document.createElement('span');
            valueDisplay.className = "font-mono text-sm text-gray-700 bg-gray-100 px-2 py-1 rounded w-16 text-center";
            valueDisplay.textContent = '0.00';

            // Event listener to update display and re-calculate
            slider.addEventListener('input', () => {
                valueDisplay.textContent = parseFloat(slider.value).toFixed(2);
                computeAndRender();
            });
            
            controlsWrapper.append(slider, valueDisplay);
            wrapper.append(label, controlsWrapper);
            return wrapper;
        }

        // Populate sliders
        DIMENSIONS.forEach(dim => slidersContainer.appendChild(createSliderRow(dim, 'V')));
        EMOTIONS.forEach(emo => biasContainer.appendChild(createSliderRow(emo, 'B')));

        // --- EVENT LISTENERS ---

        document.getElementById('toggle-bias').addEventListener('click', (e) => {
            const isHidden = biasContainer.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Hiển thị' : 'Ẩn đi';
        });
        
        document.getElementById('reset-v').addEventListener('click', () => {
             DIMENSIONS.forEach(dim => {
                const sliderId = `V_${dim.replace(/[^a-z0-9]/gi, '_')}`;
                const slider = document.getElementById(sliderId);
                slider.value = 0;
                // Manually trigger input event to update UI
                slider.dispatchEvent(new Event('input'));
            });
        });

        document.getElementById('export-json').addEventListener('click', () => {
            const data = calculateResults();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'emotion_activation_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });


        // --- CORE CALCULATION LOGIC ---

        function getVector(prefix, keys) {
            const vector = {};
            keys.forEach(key => {
                const sliderId = `${prefix}_${key.replace(/[^a-z0-9]/gi, '_')}`;
                vector[key] = parseFloat(document.getElementById(sliderId).value);
            });
            return vector;
        }

        function calculateResults() {
            const V_array = DIMENSIONS.map(dim => getVector('V', DIMENSIONS)[dim]);
            const B = getVector('B', EMOTIONS);

            const results = EMOTIONS.map(emotion => {
                const W_e = WEIGHTS[emotion];
                
                // Dot product W_e ⋅ V
                const dotProduct = W_e.reduce((acc, w, i) => acc + w * V_array[i], 0);
                
                const a_raw = dotProduct + B[emotion];
                const a_tilde = Math.tanh(a_raw);

                return { emotion, a_raw, a_tilde };
            });

            // Sort results by a_tilde descending
            results.sort((a, b) => b.a_tilde - a.a_tilde);
            
            return results;
        }


        // --- RENDERING LOGIC ---

        function renderResults() {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = ''; // Clear previous results
            const results = calculateResults();

            results.forEach(result => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200";

                const emotionCell = document.createElement('td');
                emotionCell.className = "p-3 font-medium text-gray-800";
                emotionCell.textContent = result.emotion;
                
                const rawCell = document.createElement('td');
                rawCell.className = "p-3 font-mono text-gray-600 text-right";
                rawCell.textContent = result.a_raw.toFixed(3);

                const tildeCell = document.createElement('td');
                tildeCell.className = "p-3 font-mono font-semibold text-gray-800 text-right";
                tildeCell.textContent = result.a_tilde.toFixed(3);
                
                tr.append(emotionCell, rawCell, tildeCell);
                tbody.appendChild(tr);
            });
        }

        // --- INITIALIZATION ---
        
        function computeAndRender() {
            renderResults();
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', computeAndRender);

    </script>
</body>
</html>
